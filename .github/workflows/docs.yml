name: Documentation

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
  pull_request:
    branches: [main]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  docs:
    name: Build Docs (non-strict)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - id: detect
        name: Detect MkDocs configuration
        shell: bash
        run: |
          set -euo pipefail
          if [ -f mkdocs.yml ]; then
            echo "has_mkdocs=true" >> "$GITHUB_OUTPUT"
            echo "config=mkdocs.yml" >> "$GITHUB_OUTPUT"
          elif [ -f docs/mkdocs.yml ]; then
            echo "has_mkdocs=true" >> "$GITHUB_OUTPUT"
            echo "config=docs/mkdocs.yml" >> "$GITHUB_OUTPUT"
          else
            echo "has_mkdocs=false" >> "$GITHUB_OUTPUT"
          fi
      - uses: actions/setup-python@v5
        if: steps.detect.outputs.has_mkdocs == 'true'
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install MkDocs dependencies
        if: steps.detect.outputs.has_mkdocs == 'true'
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f docs/requirements.txt ]; then
            pip install -r docs/requirements.txt
          fi
          pip install mkdocs mkdocs-material mkdocs-awesome-pages-plugin 'mkdocstrings[python]>=0.24'
      - name: Build MkDocs site (non-strict)
        if: steps.detect.outputs.has_mkdocs == 'true'
        run: |
          set -euo pipefail
          if [ "${{ steps.detect.outputs.config }}" == 'mkdocs.yml' ]; then
            mkdocs build --no-strict --site-dir site
          elif [ "${{ steps.detect.outputs.config }}" == 'docs/mkdocs.yml' ]; then
            cd docs
            mkdocs build --no-strict --site-dir ../site
          else
            echo "No mkdocs config found"
          fi
      - name: Upload site artifact
        if: steps.detect.outputs.has_mkdocs == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: docs-site
          path: site
          retention-days: 7
      - name: Skip documentation build
        if: steps.detect.outputs.has_mkdocs != 'true'
        run: echo "No MkDocs configuration detected, skipping build."

  docs-status:
    name: Docs Status
    needs: [docs]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - run: |
          echo "Docs job result: ${{ needs.docs.result }}"
          exit 0

  docs-linkcheck:
    name: Docs Link Check (report-only)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - id: detect
        name: Detect MkDocs configuration
        shell: bash
        run: |
          set -euo pipefail
          if [ -f mkdocs.yml ] || [ -f docs/mkdocs.yml ]; then
            echo "has_mkdocs=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_mkdocs=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Install lychee link checker
        if: steps.detect.outputs.has_mkdocs == 'true'
        run: |
          set -euo pipefail
          tmpdir=$(mktemp -d)
          archive="$tmpdir/lychee.tar.gz"
          download_url=$(curl -fsSL https://api.github.com/repos/lycheeverse/lychee/releases/latest \
            | jq -r '.assets[] | select(.name | test("x86_64-unknown-linux-gnu\\.tar\\.gz$")) | .browser_download_url' \
            | head -n1)
          if [ -z "$download_url" ]; then
            echo "Failed to resolve lychee download URL" >&2
            exit 1
          fi
          curl -fsSL "$download_url" -o "$archive"
          tar -xzf "$archive" -C "$tmpdir"
          sudo install "$tmpdir"/lychee /usr/local/bin/lychee
      - name: Run link check
        if: steps.detect.outputs.has_mkdocs == 'true'
        run: |
          set +e
          lychee --verbose --no-progress --max-concurrency 4 \
            --exclude-mail --exclude 'http://localhost' \
            --header "User-Agent: GW2Optimizer/CI" \
            docs/**/*.md > linkcheck.txt
          echo "Link check completed (exit code ignored)."
      - name: Upload linkcheck report
        if: steps.detect.outputs.has_mkdocs == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: docs-linkcheck-report
          path: linkcheck.txt
          retention-days: 7
      - name: Skip link check
        if: steps.detect.outputs.has_mkdocs != 'true'
        run: echo "No MkDocs configuration detected, skipping link check."
