name: Documentation

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
  pull_request:
    branches: [main]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - id: detect
        name: Detect documentation stack
        run: |
          set -euo pipefail
          mkdocs_root=false
          if [ -f mkdocs.yml ]; then
            mkdocs_root=true
          elif [ -f docs/mkdocs.yml ]; then
            mkdocs_root=true
          fi
          docusaurus_root=false
          if find . -maxdepth 1 -name 'docusaurus.config.*' -print -quit | grep -q .; then
            docusaurus_root=true
          elif find docs -name 'docusaurus.config.*' -print -quit | grep -q .; then
            docusaurus_root=true
          fi
          if $mkdocs_root; then
            echo "stack=mkdocs" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if $docusaurus_root; then
            echo "stack=docusaurus" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "stack=none" >> "$GITHUB_OUTPUT"
      - uses: actions/setup-python@v5
        if: steps.detect.outputs.stack == 'mkdocs'
        with:
          python-version: '3.11'
      - name: Install MkDocs dependencies
        if: steps.detect.outputs.stack == 'mkdocs'
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f docs/requirements.txt ]; then
            pip install -r docs/requirements.txt
          fi
          pip install mkdocs mkdocs-material mkdocs-awesome-pages-plugin 'mkdocstrings[python]>=0.24'
      - name: Build MkDocs site
        if: steps.detect.outputs.stack == 'mkdocs'
        run: |
          set -euo pipefail
          if [ -f mkdocs.yml ]; then
            mkdocs build --strict
          else
            cd docs
            mkdocs build --strict
          fi
      - name: Skip documentation build
        if: steps.detect.outputs.stack == 'none'
        run: echo "No documentation stack detected, skipping build."

  docs-status:
    name: Docs Status
    needs: [docs]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Report docs result
        run: |
          echo "Docs job result: ${{ needs.docs.result }}"
          exit 0
