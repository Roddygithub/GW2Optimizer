============================= test session starts ==============================
platform linux -- Python 3.13.7, pytest-7.4.4, pluggy-1.6.0 -- /home/roddy/.cache/pypoetry/virtualenvs/gw2optimizer-backend-Zz5vmoK9-py3.13/bin/python
cachedir: .pytest_cache
rootdir: /home/roddy/GW2Optimizer/backend
configfile: pytest.ini
plugins: anyio-4.11.0, asyncio-0.21.2, cov-4.1.0
asyncio: mode=Mode.AUTO
collecting ... collected 1 item

tests/test_services/test_ai_service.py::TestAIService::test_run_agent_recommender_mocked FAILED [100%]

=================================== FAILURES ===================================
_______________ TestAIService.test_run_agent_recommender_mocked ________________

self = <tests.test_services.test_ai_service.TestAIService object at 0x7f97f8821bd0>
mock_ollama_response = {'created_at': '2023-01-01T00:00:00Z', 'response': '{"build_name": "Mocked Firebrand", "description": "A mocked build ...stions": ["Add more CC"], "overall_rating": 8.5, "optimized_composition": ["Guardian", "Necromancer"], "changes": []}'}

    async def test_run_agent_recommender_mocked(self, mock_ollama_response):
        """Test running the recommender agent with a mocked LLM response."""
        # Create a mock response object
        mock_response = MagicMock()
        mock_response.json.return_value = mock_ollama_response
        mock_response.raise_for_status.return_value = None
    
        # Patch httpx.AsyncClient BEFORE initializing service so agents get mocked clients
        with patch("httpx.AsyncClient") as MockClient:
            mock_client_instance = AsyncMock()
            mock_client_instance.post.return_value = mock_response
            MockClient.return_value.__aenter__.return_value = mock_client_instance
    
            service = AIService()
            await service.initialize()
    
            # For agents that create their own persistent clients (like SynergyAgent),
            # we need to replace their post method directly
            for agent in service.agents.values():
                if hasattr(agent, "_client") and agent._client:
                    agent._client.post = AsyncMock(return_value=mock_response)
    
            result = await service.run_agent("recommender", {
                "profession": "Guardian",
                "role": "Support",
                "game_mode": "WvW"
            })
    
            assert result["success"] is True
>           assert result["agent"] == "recommender"
E           AssertionError: assert 'RecommenderAgent' == 'recommender'
E             - recommender
E             + RecommenderAgent

tests/test_services/test_ai_service.py:95: AssertionError
----------------------------- Captured stdout call -----------------------------
{"event": "\u2705 AI Service initialized with 3 agents and 3 workflows", "level": "info", "timestamp": "2025-11-21T14:35:47.617353Z"}
{"event": "\ud83d\udce6 Available agents: recommender, synergy, optimizer", "level": "info", "timestamp": "2025-11-21T14:35:47.617429Z"}
{"event": "\ud83d\udd04 Available workflows: build_optimization, team_analysis, learning", "level": "info", "timestamp": "2025-11-21T14:35:47.617459Z"}
{"event": "\ud83d\ude80 Initializing AI Service...", "level": "info", "timestamp": "2025-11-21T14:35:47.617482Z"}
{"event": "Initializing agent: RecommenderAgent v1.0.0", "level": "info", "timestamp": "2025-11-21T14:35:47.617503Z"}
{"event": "HTTP client initialized for http://localhost:11434", "level": "info", "timestamp": "2025-11-21T14:35:47.617547Z"}
{"event": "Agent RecommenderAgent initialized successfully", "level": "info", "timestamp": "2025-11-21T14:35:47.617568Z"}
{"event": "\u2705 Agent 'recommender' initialized", "level": "info", "timestamp": "2025-11-21T14:35:47.617586Z"}
{"event": "Initializing agent: SynergyAgent v1.0.0", "level": "info", "timestamp": "2025-11-21T14:35:47.617604Z"}
{"event": "HTTP client initialized for http://localhost:11434", "level": "info", "timestamp": "2025-11-21T14:35:47.617635Z"}
{"event": "Agent SynergyAgent initialized successfully", "level": "info", "timestamp": "2025-11-21T14:35:47.617653Z"}
{"event": "\u2705 Agent 'synergy' initialized", "level": "info", "timestamp": "2025-11-21T14:35:47.617669Z"}
{"event": "Initializing agent: OptimizerAgent v1.0.0", "level": "info", "timestamp": "2025-11-21T14:35:47.617685Z"}
{"event": "Initializing agent: SynergyAgent v1.0.0", "level": "info", "timestamp": "2025-11-21T14:35:47.617715Z"}
{"event": "HTTP client initialized for http://localhost:11434", "level": "info", "timestamp": "2025-11-21T14:35:47.617742Z"}
{"event": "Agent SynergyAgent initialized successfully", "level": "info", "timestamp": "2025-11-21T14:35:47.617759Z"}
{"event": "Optimizer agent initialized with synergy analysis capability", "level": "info", "timestamp": "2025-11-21T14:35:47.617774Z"}
{"event": "Agent OptimizerAgent initialized successfully", "level": "info", "timestamp": "2025-11-21T14:35:47.617789Z"}
{"event": "\u2705 Agent 'optimizer' initialized", "level": "info", "timestamp": "2025-11-21T14:35:47.617804Z"}
{"event": "\u2705 AI Service fully initialized", "level": "info", "timestamp": "2025-11-21T14:35:47.617819Z"}
{"event": "\ud83e\udd16 Executing agent 'recommender'...", "level": "info", "timestamp": "2025-11-21T14:35:47.618321Z"}
{"event": "Executing agent: RecommenderAgent with inputs: ['profession', 'role', 'game_mode']", "level": "info", "timestamp": "2025-11-21T14:35:47.618359Z"}
{"event": "Build recommendation generated for Guardian Support in WvW", "level": "info", "timestamp": "2025-11-21T14:35:47.618491Z"}
{"event": "Agent RecommenderAgent executed successfully in 0.00s", "level": "info", "timestamp": "2025-11-21T14:35:47.618528Z"}
=============================== warnings summary ===============================
app/models/chat.py:23
  /home/roddy/GW2Optimizer/backend/app/models/chat.py:23: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator("content")

app/models/chat.py:40
  /home/roddy/GW2Optimizer/backend/app/models/chat.py:40: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator("conversation_history")

app/models/chat.py:66
  /home/roddy/GW2Optimizer/backend/app/models/chat.py:66: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator("gw2skills_url")

app/models/chat.py:81
  /home/roddy/GW2Optimizer/backend/app/models/chat.py:81: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ChatResponse(BaseModel):

../../.cache/pypoetry/virtualenvs/gw2optimizer-backend-Zz5vmoK9-py3.13/lib/python3.13/site-packages/pydantic/_internal/_config.py:383
  /home/roddy/.cache/pypoetry/virtualenvs/gw2optimizer-backend-Zz5vmoK9-py3.13/lib/python3.13/site-packages/pydantic/_internal/_config.py:383: UserWarning: Valid config keys have changed in V2:
  * 'schema_extra' has been renamed to 'json_schema_extra'
    warnings.warn(message, UserWarning)

../../.cache/pypoetry/virtualenvs/gw2optimizer-backend-Zz5vmoK9-py3.13/lib/python3.13/site-packages/pydantic_core/core_schema.py:4434
  /home/roddy/.cache/pypoetry/virtualenvs/gw2optimizer-backend-Zz5vmoK9-py3.13/lib/python3.13/site-packages/pydantic_core/core_schema.py:4434: DeprecationWarning: `FieldValidationInfo` is deprecated, use `ValidationInfo` instead.
    warnings.warn(msg, DeprecationWarning, stacklevel=1)

app/models/user.py:24
  /home/roddy/GW2Optimizer/backend/app/models/user.py:24: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'example'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    email: EmailStr = Field(..., description="User's unique email address.", example="user@example.com")

app/models/user.py:25
  /home/roddy/GW2Optimizer/backend/app/models/user.py:25: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'example'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    username: str = Field(

app/models/user.py:39
  /home/roddy/GW2Optimizer/backend/app/models/user.py:39: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'example'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    password: str = Field(

app/models/user.py:80
  /home/roddy/GW2Optimizer/backend/app/models/user.py:80: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'example'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    full_name: Optional[str] = Field(None, max_length=100, example="John Doe")

app/models/user.py:81
  /home/roddy/GW2Optimizer/backend/app/models/user.py:81: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'example'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    bio: Optional[str] = Field(None, max_length=500, example="Experienced GW2 player.")

app/models/user.py:82
  /home/roddy/GW2Optimizer/backend/app/models/user.py:82: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'example'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    profile_picture_url: Optional[str] = Field(None, example="https://example.com/avatar.png")

app/models/user.py:83
  /home/roddy/GW2Optimizer/backend/app/models/user.py:83: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'example'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    preferences: Optional[Dict[str, Any]] = Field(None, example={"theme": "dark", "language": "en"})

app/models/user.py:87
  /home/roddy/GW2Optimizer/backend/app/models/user.py:87: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'example'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    preferences: Dict[str, Any] = Field(..., example={"theme": "dark", "notifications_enabled": True})

app/models/user.py:90
  /home/roddy/GW2Optimizer/backend/app/models/user.py:90: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class UserOut(UserBase):

app/models/user.py:105
  /home/roddy/GW2Optimizer/backend/app/models/user.py:105: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class LoginHistoryOut(BaseModel):

app/schemas/builds.py:19
  /home/roddy/GW2Optimizer/backend/app/schemas/builds.py:19: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class BuildSuggestionOut(BaseModel):

tests/conftest.py:300
  /home/roddy/GW2Optimizer/backend/tests/conftest.py:300: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class TestUser(UserOut):

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_services/test_ai_service.py::TestAIService::test_run_agent_recommender_mocked
======================== 1 failed, 18 warnings in 0.06s ========================
